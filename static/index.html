<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>树洞 - 匿名分享你的想法</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .post-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .comment-section {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 0 0 10px 10px;
        }
        .comment {
            border-left: 3px solid #6c757d;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }
        .text-container {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-5">
            <h1 class="display-4">树洞</h1>
            <p class="lead">在这里匿名分享你的想法和感受</p>
        </header>

        <div class="row">
            <!-- 发帖区域 -->
            <div class="col-md-8 offset-md-2 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">写下你想说的...</h5>
                        <div class="mb-3">
                            <textarea id="new-post-content" class="form-control" rows="4" placeholder="在这里分享你的想法..."></textarea>
                        </div>
                        <button id="submit-post" class="btn btn-primary float-end">发布</button>
                    </div>
                </div>
            </div>

            <!-- 帖子列表 -->
            <div class="col-md-8 offset-md-2">
                <div id="posts-container">
                    <!-- 帖子内容将通过JS动态加载 -->
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="帖子分页">
                        <ul id="pagination" class="pagination">
                            <!-- 分页内容将通过JS动态加载 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 帖子模板 -->
    <template id="post-template">
        <div class="card post-card">
            <div class="card-body">
                <div class="text-container post-content"></div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="post-time"></small>
                    <button class="btn btn-sm btn-outline-secondary show-comments">评论 (<span class="comments-count">0</span>)</button>
                </div>
            </div>
            <div class="comment-section d-none">
                <div class="comments-list">
                    <!-- 评论内容将通过JS动态加载 -->
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <textarea class="form-control new-comment-content" placeholder="添加评论..."></textarea>
                        <button class="btn btn-outline-primary submit-comment">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 评论模板 -->
    <template id="comment-template">
        <div class="comment">
            <div class="text-container comment-content"></div>
            <small class="post-time comment-time"></small>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiBaseUrl = '/api';
            let currentPage = 1;
            let totalPages = 1;
            
            // 加载帖子列表
            function loadPosts(page = 1) {
                fetch(`${apiBaseUrl}/posts?page=${page}&per_page=10`)
                    .then(response => response.json())
                    .then(data => {
                        const postsContainer = document.getElementById('posts-container');
                        postsContainer.innerHTML = '';
                        
                        if (data.posts.length === 0) {
                            postsContainer.innerHTML = '<div class="text-center">还没有帖子，来发布第一个吧！</div>';
                            return;
                        }
                        
                        data.posts.forEach(post => {
                            const postElement = createPostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        
                        totalPages = Math.ceil(data.total / data.page_size);
                        updatePagination(data.page, totalPages);
                    })
                    .catch(error => {
                        console.error('Error loading posts:', error);
                        document.getElementById('posts-container').innerHTML = 
                            '<div class="alert alert-danger">加载帖子失败，请刷新页面重试。</div>';
                    });
            }
            
            // 创建帖子元素
            function createPostElement(post) {
                const template = document.getElementById('post-template');
                const postElement = document.importNode(template.content, true).querySelector('.post-card');
                
                postElement.dataset.postId = post.id;
                postElement.querySelector('.post-content').textContent = post.content;
                postElement.querySelector('.post-time').textContent = formatDate(post.created_at);
                postElement.querySelector('.comments-count').textContent = post.comments_count;
                
                // 绑定显示评论事件
                const showCommentsBtn = postElement.querySelector('.show-comments');
                showCommentsBtn.addEventListener('click', function() {
                    const commentSection = this.closest('.card').querySelector('.comment-section');
                    commentSection.classList.toggle('d-none');
                    
                    if (!commentSection.classList.contains('d-none')) {
                        loadComments(post.id, commentSection);
                    } else {
                        // 如果隐藏评论区，清空已加载的评论内容，下次打开时重新加载
                        commentSection.querySelector('.comments-list').innerHTML = '';
                    }
                });
                
                // 绑定提交评论事件
                const submitCommentBtn = postElement.querySelector('.submit-comment');
                submitCommentBtn.addEventListener('click', function() {
                    const content = this.closest('.input-group').querySelector('.new-comment-content').value.trim();
                    if (content) {
                        submitComment(post.id, content, postElement);
                    }
                });
                
                return postElement;
            }
            
            // 加载评论
            function loadComments(postId, commentSection) {
                const commentsList = commentSection.querySelector('.comments-list');
                commentsList.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
                
                fetch(`${apiBaseUrl}/posts/${postId}/comments`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        commentsList.innerHTML = '';
                        
                        if (!data.comments || data.comments.length === 0) {
                            commentsList.innerHTML = '<div class="text-center text-muted">暂无评论</div>';
                            return;
                        }
                        
                        data.comments.forEach(comment => {
                            const commentElement = createCommentElement(comment);
                            commentsList.appendChild(commentElement);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading comments:', error);
                        commentsList.innerHTML = '<div class="alert alert-danger">加载评论失败</div>';
                    });
            }
            
            // 创建评论元素
            function createCommentElement(comment) {
                const template = document.getElementById('comment-template');
                const commentElement = document.importNode(template.content, true).querySelector('.comment');
                
                commentElement.dataset.commentId = comment.id;
                commentElement.querySelector('.comment-content').textContent = comment.content;
                commentElement.querySelector('.comment-time').textContent = formatDate(comment.created_at);
                
                return commentElement;
            }
            
            // 提交评论
            function submitComment(postId, content, postElement) {
                fetch(`${apiBaseUrl}/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(comment => {
                    // 清空评论框
                    postElement.querySelector('.new-comment-content').value = '';
                    
                    // 更新评论列表
                    const commentsList = postElement.querySelector('.comments-list');
                    const emptyMessage = commentsList.querySelector('.text-muted');
                    if (emptyMessage) {
                        commentsList.innerHTML = '';
                    }
                    
                    const commentElement = createCommentElement(comment);
                    commentsList.appendChild(commentElement);
                    
                    // 更新评论计数
                    const countElement = postElement.querySelector('.comments-count');
                    countElement.textContent = parseInt(countElement.textContent) + 1;
                })
                .catch(error => {
                    console.error('Error submitting comment:', error);
                    alert('发送评论失败，请重试。');
                });
            }
            
            // 提交新帖子
            document.getElementById('submit-post').addEventListener('click', function() {
                const content = document.getElementById('new-post-content').value.trim();
                if (content) {
                    const submitBtn = this;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '发布中...';
                    
                    fetch(`${apiBaseUrl}/posts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(post => {
                        document.getElementById('new-post-content').value = '';
                        // 重新加载第一页
                        loadPosts(1);
                    })
                    .catch(error => {
                        console.error('Error submitting post:', error);
                        alert('发布失败，请重试。');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '发布';
                    });
                }
            });
            
            // 更新分页
            function updatePagination(currentPage, totalPages) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                
                if (totalPages <= 1) {
                    return;
                }
                
                // 上一页按钮
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.innerHTML = '&laquo;';
                prevLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentPage > 1) {
                        loadPosts(currentPage - 1);
                    }
                });
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // 页码按钮
                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadPosts(i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // 下一页按钮
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.innerHTML = '&raquo;';
                nextLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        loadPosts(currentPage + 1);
                    }
                });
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
            }
            
            // 格式化日期
            function formatDate(dateString) {
                try {
                    // 处理 ISO 8601 格式的时间字符串
                    if (typeof dateString === 'string') {
                        // 尝试使用标准 ISO 格式解析
                        let parsedDate;
                        
                        // 修复各种可能的日期格式问题
                        if (dateString.includes('Z')) {
                            // 如果已经是带有Z的UTC时间格式
                            parsedDate = new Date(dateString);
                        } else if (dateString.includes('T')) {
                            // 已经是ISO格式但可能缺少Z
                            parsedDate = new Date(dateString + 'Z');
                        } else {
                            // 尝试将空格格式转换为T格式
                            parsedDate = new Date(dateString.replace(' ', 'T') + 'Z');
                        }
                        
                        if (!isNaN(parsedDate.getTime())) {
                            return parsedDate.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                            });
                        }
                    }
                    
                    // 作为最后的尝试，直接解析
                    const date = new Date(dateString);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                        });
                    }
                    
                    console.log("无法解析的日期:", dateString);
                    // 如果所有解析都失败，返回一个替代文本
                    return "刚刚";
                } catch (e) {
                    console.error("日期格式化错误:", e, "原始日期:", dateString);
                    return "刚刚";
                }
            }
            
            // 初始加载
            loadPosts();
        });
    </script>
</body>
</html>